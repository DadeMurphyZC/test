"use strict";(()=>{var p=e=>e!==void 0;var b={Accept:"application/vnd.lichess.v5+json"},u={cache:"no-cache",credentials:"same-origin"},m={"X-Requested-With":"XMLHttpRequest"},T=e=>{if(e.ok)return e;throw e.status==429?new Error("Too many requests"):e.status==413?new Error("The uploaded file is too large"):new Error(`Error ${e.status}`)},g=(e,t={})=>k(e,t).then(o=>T(o).json()),k=(e,t={})=>fetch(e,{...u,headers:{...b,...m},...t});var w=(e,t)=>{let o=new URLSearchParams;for(let r of Object.keys(t))p(t[r])&&o.append(r,t[r]);let n=o.toString();return n?`${e}?${n}`:e};function h(e,t,o=!1){let n,r=0;return function(...s){let f=this;n&&clearTimeout(n),n=void 0;let a=performance.now()-r;r=performance.now(),o&&a>t?e.apply(f,s):n=setTimeout(()=>{n=void 0,e.apply(f,s)},t)}}var y=lichess.storage;var S=(e,t)=>o=>{if(p(o))return y.set(e,JSON.stringify(o)),o;let n=JSON.parse(y.get(e));return n!==null?n:t()};var x=class{constructor(){this.historyStorage=S("login.history",()=>[]);this.now=()=>Math.round(Date.now()/1e3);this.add=()=>{let t=this.now();this.historyStorage([t,...this.historyStorage().filter(o=>o>t-30)])};this.lockSeconds=()=>{let t=this.now(),o=this.historyStorage().filter(n=>n>t-30);if(o.length>=3)return Math.max(0,o[o.length-1]+30-t)}}};function P(){let e=".auth-login form",t=new x,o=(n,r)=>n.prop("disabled",!r).toggleClass("disabled",!r);(function n(){let r=document.querySelector(e),s=$(r);if(t.lockSeconds()){let a=s.find(".submit"),c=o(a,!1).text(),i=()=>{let l=t.lockSeconds();l?(a.text(""+l),setTimeout(i,1e3)):a.text(c).prop("disabled",!1).removeClass("disabled")};i()}r.addEventListener("submit",a=>{a.preventDefault(),o(s.find(".submit"),!1),fetch(r.action,{...u,headers:m,method:"post",body:new FormData(r)}).then(c=>c.text().then(i=>[c,i])).then(([c,i])=>{if(i==="MissingTotpToken"||i==="InvalidTotpToken")s.find(".one-factor").hide(),s.find(".two-factor").removeClass("none"),requestAnimationFrame(()=>s.find(".two-factor input").val("")[0].focus()),o(s.find(".submit"),!0),i==="InvalidTotpToken"&&s.find(".two-factor .error").removeClass("none");else if(c.ok)location.href=i.startsWith("ok:")?i.slice(3):"/";else try{let l=$(i).find(e);l.length?(t.add(),s.replaceWith(l),n()):(alert(i||c.statusText+". Please wait some time before trying again."),o(s.find(".submit"),!0))}catch(l){console.warn(l),s.html(i)}})})})()}function v(){let e=$("#signup-form"),t=e.find(".username-exists"),o=e.find('input[name="username"]').on("change keyup paste",()=>{t.addClass("none"),n()}),n=h(()=>{let r=o.val();r.length>=3&&g(w("/api/player/autocomplete",{term:r,exists:1})).then(s=>t.toggleClass("none",!s))},300);e.on("submit",()=>{if(e.find('[name="h-captcha-response"]').val()||!e.hasClass("h-captcha-enabled"))e.find("button.submit").prop("disabled",!0).removeAttr("data-icon").addClass("frameless").html(lichess.spinnerHtml);else return!1}),lichess.loadModule("passwordComplexity").then(()=>window.passwordComplexity.addPasswordChangeListener("form3-password"))}window.loginSignup={loginStart:P,signupStart:v};})();